input {
  beats {
    port => 5044
  }
}

filter {
  # remove special characters for index name building
  grok {
    match => ["source","%{GREEDYDATA}/%{GREEDYDATA:nombreindex}\.csv"]
  }
  mutate {
    gsub => [ "nombreindex", "-", ""]
    gsub => [ "nombreindex", "\_", ""]
    gsub => [ "nombreindex", "\.", ""]
    gsub => [ "nombreindex", " ", ""]
    lowercase => [ "nombreindex" ]
  }
  # remove special characters coming from filebeat
  mutate {
    gsub => [ 'message', '\"', '' ] #funciona bien, elimina las comillas bien
    gsub => [ 'message', '\[', '' ] #comprobados ok
    gsub => [ 'message', '\]', '' ] #comprobados ok
    gsub => [ 'message', '\(', '' ] #comprobados ok
    gsub => [ 'message', '\)', '' ] #comprobados ok
    gsub => [ 'message', '\{', '' ] #comprobados ok
    gsub => [ 'message', '\&', '' ] #comprobados ok
    gsub => [ 'message', '\}', '' ] #comprobados ok
    gsub => [ 'message', '\#', '' ] #comprobados ok????
    gsub => [ 'message', '\?', '' ] #comprobados ok????
    gsub => [ 'message', '\<', '' ] #comprobados ok?
    gsub => [ 'message', '\>', '' ] #comprobados ok?
    gsub => [ 'message', '\|', '' ] #comprobados ok?
    gsub => [ 'message', '\/', '' ] #comprobados ok?
    #gsub => [ 'message', '\', '' ] #esto peta completamente el contenedor de logstash
  }
  # parsing csv with dns log structure in folder /csvtoparse/dns
  if [log_type] == "dns" {
    grok {
      match => { "message" => "%{WORD:pais}?,%{WORD:aplicacion}?,%{TIMESTAMP_ISO8601:event_date}?,%{WORD:host}?,%{HOSTNAME:clon}?,%{TIMESTAMP_ISO8601:fec_operacion}?,%{WORD:operation}?,%{IPV4:ip_server}?,%{IPV4:ip_client}?,%{POSINT:port_client}?,%{HOSTNAME:request}?,(?<requesttype>\b[0-9A-Za-z\.\-\:]{0,62}\b)?,%{GREEDYDATA:message}?"
      }
    }
    date {
      match => [ "fec_operacion", "yyyy-MM-dd' 'HH:mm:ss'.'SSSSSSSSS" ]
      target => "fec_operacion"
    }
  }
  # parsing csv with proxy log structure in folder /csvtoparse/proxy
  if [log_type] == "proxy" {
    csv {
      separator => ","
      columns => ["country","aplicacion","event_date","host","clon","fec_operacion","ip_client","user","referer","cod_response","method","content_type","uri_host","port","uri_path","user_agent","bytes_response","bytes_request","mensaje","pais","tipo","app","fecha"]
      skip_header => true
    }
    date {
      match => [ "fec_operacion", "yyyy-MM-dd' 'HH:mm:ss'.'SSSSSSSSS" ]
      target => "fec_operacion"
    }
  }
  # parsing csv with dcwindows log structure in folder /csvtoparse/dcwindows
  if [log_type] == "dc" { #el timestamp no va
    csv {
      separator => ","
      columns => ["pais_","aplicacion","event_date","host","clon","fec_operacion","cod_operation","operation","category","host_ip","user","user_domain","source_address","tipo_sesion","id_sesion","mensaje","affected_user","affected_user_domain","old_account_name","nombre_sesion","process_name","error_code","error_status","error_substatus","source_hostname","source_port","target_server","privileges","affected_group","affected_group_domain","affected_task","object_type","object_name","handle_id","resources_attributes","req_accesses","affected_rights","service_file_name","service_type","service_account","parsed_op","pais","tipo","app","fecha"]
      skip_header => true
      skip_empty_columns => true
    }
    date {
      match => [ "fec_operacion", "yyyy-MM-dd' 'HH:mm:ss", "yyyy-MM-dd' 'HH:mm:ss'.'SSSSSSSSS" ]
      target => "fec_operacion"
    }
  }
  #autoparse the other csv log files located in csvtoparse folder
  else {
    csv {
      separator => ","
      autodetect_column_names => true
      autogenerate_column_names => true        # use only if csv file has some no titled columns
      skip_header => true
      skip_empty_columns => true
    }
    date {
      match => [ "fec_operacion", "yyyy-MM-dd' 'HH:mm:ss'.'SSSSSSSSS" ]
      target => "fec_operacion"
    }
  }
}

output {
  elasticsearch {
      hosts => "elasticsearch1:9200"
      index => "csv-%{nombreindex}"
#      template => "./shards.json"
#      template_name => "shards"
#      template_overwrite => "false"
  }
}
